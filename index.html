<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>BTG Technology â€“ Payment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- QR library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js"></script>
</head>
<body>

<h2>Payment Request</h2>

<p>
  <strong>Service:</strong> Consulting â€“ Invoice #921862105<br>
  <strong>Amount:</strong> 0.22802885021015 ETH
</p>

<h3>Step 1: Scan with Trust Wallet</h3>
<img id="qrimg" style="width:260px;height:260px;border:1px solid #ccc" />

<h3>Step 2: Pay</h3>
<button id="pay" disabled>Pay Now</button>

<pre id="log" style="white-space:pre-wrap;color:red;margin-top:20px;"></pre>

<script type="module">
  import SignClient from "https://esm.sh/@walletconnect/sign-client";

  /* ================= CONFIG ================= */

  const PROJECT_ID = "3a25f7e3ad4aa26d7d4fc629e48a06b7";
  const RECEIVING_ADDRESS =
    "0xA25900EA2A1915D549FB5a9CFb0a4FCA27a6Cd35";
  const VALUE_HEX = "0x0329f6b8d8c4c1e0";

  /* ========================================== */

  let client;
  let session;
  let userAddress;

  const log = (msg) => {
    document.getElementById("log").textContent += msg + "\n";
  };

  async function init() {
    client = await SignClient.init({
      projectId: PROJECT_ID,
      metadata: {
        name: "BTG Technology",
        description: "Invoice payment",
        url: window.location.href,
        icons: []
      }
    });

    log("WalletConnect initialized");

    // ðŸ”¥ FORCE CLEAR OLD SESSIONS
    if (client.session.values.length > 0) {
      log("Clearing old WalletConnect sessions...");
      for (const s of client.session.values) {
        await client.disconnect({
          topic: s.topic,
          reason: { code: 6000, message: "Reset session" }
        });
      }
    }

    await createConnection();
  }

  async function createConnection() {
    log("Creating WalletConnect session...");

    const { uri, approval } = await client.connect({
      requiredNamespaces: {
        eip155: {
          methods: ["eth_sendTransaction"],
          chains: ["eip155:1"],
          events: []
        }
      }
    });

    if (!uri) {
      log("âŒ NO URI RETURNED â€” QR CANNOT BE GENERATED");
      log("Refresh the page and try again.");
      return;
    }

    log("URI received, generating QR...");

    // âœ… MOST RELIABLE QR METHOD
    const qrDataUrl = await QRCode.toDataURL(uri);
    document.getElementById("qrimg").src = qrDataUrl;

    log("QR code visible. Scan with Trust Wallet.");

    // Wait for wallet to scan & approve
    session = await approval();
    userAddress = session.namespaces.eip155.accounts[0].split(":")[2];

    log("Wallet connected:");
    log("From: " + userAddress);
    log("To:   " + RECEIVING_ADDRESS);

    document.getElementById("pay").disabled = false;
  }

  document.getElementById("pay").onclick = async () => {
    try {
      log("Requesting payment...");

      const tx = await client.request({
        topic: session.topic,
        chainId: "eip155:1",
        request: {
          method: "eth_sendTransaction",
          params: [
            {
              from: userAddress,
              to: RECEIVING_ADDRESS,
              value: VALUE_HEX
            }
          ]
        }
      });

      log("Transaction sent!");
      log("Tx hash: " + tx);

    } catch (e) {
      log("PAYMENT ERROR:");
      log(e.message || JSON.stringify(e));
    }
  };

  init();
</script>

</body>
</html>
