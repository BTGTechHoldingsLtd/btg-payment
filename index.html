<!DOCTYPE html>
<!-- VERSION: BTG-PAYMENT-QR v1.0.8 -->
<html>
<head>
  <meta charset="UTF-8" />
  <title>BTG Technology ‚Äì Payment (v1.0.8)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>

<h1 style="color:green;">‚úÖ VERSION v1.0.8 LOADED</h1>

<h2>Payment Request</h2>

<p>
  <strong>Service:</strong> Consulting ‚Äì Invoice #921862105<br>
  <strong>Amount:</strong> 0.22802885021015 ETH
</p>

<hr>

<h3>Step 1: Generate QR</h3>
<button id="connect">Generate WalletConnect QR</button>
<br><br>
<img id="qrimg" style="display:none;width:260px;border:1px solid #ccc" />

<h3>Step 2: Pay</h3>
<button id="pay" disabled>Pay Now</button>

<pre id="log" style="white-space:pre-wrap;color:#b00020;margin-top:20px;"></pre>

<script type="module">
  import SignClient from "https://esm.sh/@walletconnect/sign-client";
  import QRCode from "https://esm.sh/qrcode@1.5.4";

  /* ================= CONFIG ================= */

  // üîë NEW PROJECT ID (THIS IS THE ONLY CHANGE)
  const PROJECT_ID = "8ca3e636b6f66f5a9ed28d6affa084de";

  // Business receiving wallet
  const RECEIVING_ADDRESS =
    "0xA25900EA2A1915D549FB5a9CFb0a4FCA27a6Cd35";

  // 0.22802885021015 ETH (wei ‚Üí hex)
  const VALUE_HEX = "0x0329f6b8d8c4c1e0";

  // Trust Wallet‚Äìrequired gas fields
  const GAS_LIMIT = "0x5208";        // 21000
  const GAS_PRICE = "0x3B9ACA00";    // 1 gwei

  /* ========================================== */

  let client;
  let session = null;
  let userAddress = null;
  let connecting = false;

  const log = (msg) => {
    document.getElementById("log").textContent += msg + "\n";
  };

  async function init() {
    client = await SignClient.init({
      projectId: PROJECT_ID,
      metadata: {
        name: "BTG Technology",
        description: "Invoice payment",
        url: window.location.origin, // still GitHub Pages
        icons: []
      }
    });

    log("WalletConnect initialized");

    // Clear stale sessions (important during testing)
    for (const s of client.session.values) {
      await client.disconnect({
        topic: s.topic,
        reason: { code: 6000, message: "Reset" }
      });
    }
  }

  document.getElementById("connect").onclick = async () => {
    if (connecting) return;
    connecting = true;

    try {
      log("Creating WalletConnect session‚Ä¶");

      const { uri, approval } = await client.connect({
        requiredNamespaces: {
          eip155: {
            methods: ["eth_sendTransaction"],
            chains: ["eip155:1"],
            events: []
          }
        }
      });

      if (!uri) {
        log("‚ùå No URI returned");
        connecting = false;
        return;
      }

      const qr = await QRCode.toDataURL(uri);
      const img = document.getElementById("qrimg");
      img.src = qr;
      img.style.display = "block";

      log("QR generated. Scan with Trust Wallet.");

      session = await approval();
      userAddress =
        session.namespaces.eip155.accounts[0].split(":")[2];

      log("Wallet connected:");
      log("From: " + userAddress);
      log("To:   " + RECEIVING_ADDRESS);

      document.getElementById("pay").disabled = false;

    } catch (e) {
      log("CONNECT ERROR:");
      log(e.message || JSON.stringify(e));
    } finally {
      connecting = false;
    }
  };

  document.getElementById("pay").onclick = async () => {
    if (!session) {
      log("‚ùå No active session");
      return;
    }

    try {
      log("Requesting payment‚Ä¶");

      const tx = await client.request({
        topic: session.topic,
        chainId: "eip155:1",
        request: {
          method: "eth_sendTransaction",
          params: [{
            from: userAddress,
            to: RECEIVING_ADDRESS,
            value: VALUE_HEX,
            gas: GAS_LIMIT,
            gasPrice: GAS_PRICE,
            data: "0x"
          }]
        }
      });

      log("Transaction sent!");
      log("Tx hash: " + tx);

    } catch (e) {
      log("PAYMENT ERROR:");
      log(e.message || JSON.stringify(e));
    }
  };

  init();
</script>

</body>
</html>
